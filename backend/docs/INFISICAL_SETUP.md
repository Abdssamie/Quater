# Infisical Setup Guide for Quater Backend

This guide explains how to use Infisical to securely manage secrets and certificates for the Quater Water Quality Lab Management System.

## Table of Contents

- [Prerequisites](#prerequisites)
- [Installing Infisical CLI](#installing-infisical-cli)
- [Setting Up Infisical Project](#setting-up-infisical-project)
- [Storing OpenIddict Certificates](#storing-openiddict-certificates)
- [Storing Application Secrets](#storing-application-secrets)
- [Injecting Secrets into Docker](#injecting-secrets-into-docker)
- [Certificate Rotation](#certificate-rotation)
- [Troubleshooting](#troubleshooting)

---

## Prerequisites

- Infisical account (sign up at [infisical.com](https://infisical.com))
- Infisical CLI installed (see below)
- OpenIddict certificates generated (see `backend/scripts/generate-openiddict-certs.sh`)
- Docker and Docker Compose installed

---

## Installing Infisical CLI

### Linux/macOS

```bash
# Using curl
curl -1sLf 'https://dl.cloudsmith.io/public/infisical/infisical-cli/setup.deb.sh' | sudo -E bash
sudo apt-get update && sudo apt-get install -y infisical

# Or using Homebrew (macOS)
brew install infisical/get-cli/infisical
```

### Verify Installation

```bash
infisical --version
```

---

## Setting Up Infisical Project

### 1. Login to Infisical

```bash
infisical login
```

This will open a browser window for authentication.

### 2. Initialize Project

Navigate to your project directory:

```bash
cd /home/abdssamie/ChemforgeProjects/Quater
infisical init
```

Select your Infisical project and environment (e.g., `production`, `staging`, `development`).

### 3. Verify Connection

```bash
infisical secrets
```

This should list all secrets in your current environment.

---

## Storing OpenIddict Certificates

### 1. Generate Certificates

First, generate your OpenIddict certificates:

```bash
cd /home/abdssamie/ChemforgeProjects/Quater
bash backend/scripts/generate-openiddict-certs.sh
```

This creates:
- `certs/encryption.pfx` - Encryption certificate
- `certs/signing.pfx` - Signing certificate

### 2. Convert Certificates to Base64

Infisical stores secrets as strings, so we need to encode certificates:

```bash
# Encode encryption certificate
base64 -w 0 certs/encryption.pfx > certs/encryption.pfx.b64

# Encode signing certificate
base64 -w 0 certs/signing.pfx > certs/signing.pfx.b64
```

### 3. Store Certificates in Infisical

```bash
# Store encryption certificate (base64-encoded)
infisical secrets set OPENIDDICT_ENCRYPTION_CERT_BASE64 --value="$(cat certs/encryption.pfx.b64)"

# Store signing certificate (base64-encoded)
infisical secrets set OPENIDDICT_SIGNING_CERT_BASE64 --value="$(cat certs/signing.pfx.b64)"

# Store certificate passwords
infisical secrets set OPENIDDICT_ENCRYPTION_CERT_PASSWORD --value="your-encryption-password"
infisical secrets set OPENIDDICT_SIGNING_CERT_PASSWORD --value="your-signing-password"
```

### 4. Store Certificate Paths

```bash
# These paths will be used in the container
infisical secrets set OPENIDDICT_ENCRYPTION_CERT_PATH --value="/app/certs/encryption.pfx"
infisical secrets set OPENIDDICT_SIGNING_CERT_PATH --value="/app/certs/signing.pfx"
```

---

## Storing Application Secrets

### Database Configuration

```bash
infisical secrets set DB_HOST --value="your-postgres-host"
infisical secrets set DB_PORT --value="5432"
infisical secrets set DB_NAME --value="quater_production"
infisical secrets set DB_USER --value="quater_app"
infisical secrets set DB_PASSWORD --value="your-strong-db-password"
```

### OpenIddict Configuration

```bash
# OAuth2 settings
infisical secrets set OPENIDDICT_ISSUER --value="https://api.yourdomain.com"
infisical secrets set OPENIDDICT_AUDIENCE --value="quater-api"

# Client credentials (generated by OpenIddictSeeder or manually)
infisical secrets set OPENIDDICT_CLIENT_ID --value="quater-mobile-client"
infisical secrets set OPENIDDICT_CLIENT_SECRET --value="your-64-char-client-secret"

# Token lifetimes
infisical secrets set OPENIDDICT_ACCESS_TOKEN_LIFETIME --value="3600"
infisical secrets set OPENIDDICT_REFRESH_TOKEN_LIFETIME --value="604800"
```

### Email Configuration

```bash
infisical secrets set EMAIL_SMTP_HOST --value="smtp.sendgrid.net"
infisical secrets set EMAIL_SM_USERNAME --value="apikey"
infisical secrets set EMAIL_SMTP_PASSWORD --value="your-sendgrid-api-key"
infisical secrets set EMAIL_FROM_ADDRESS --value="noreply@yourdomain.com"
infisical secrets set EMAIL_FROM_NAME --value="Quater Water Quality"
infisical secrets set EMAIL_FRONTEND_URL --value="https://app.yourdomain.com"
```

### Redis Configuration

```bash
infisical secrets set REDIS_PASSWORD --value="your-redis-password"
infisical secrets set REDIS_CONNECTION_STRING --value="redis:6379,password=your-redis-password,ssl=false,abortConnect=false"
```

### CORS Configuration

```bash
infisical secrets set CORS_ORIGIN_1 --value="https://app.yourdomain.com"
infisical secrets set CORS_ORIGIN_2 --value="https://admin.yourdomain.com"
infisical secrets set CORS_ORIGIN_3 --value="https://mobile.yourdomain.com"
```

---

## Injecting Secrets into Docker

### Method 1: Using Infisical Run Command

The simplest way to inject secrets:

```bash
# Run docker-compose with Infisical secrets
infisical run --env=production -- docker-compose -f docker/docker-compose.prod.yml up -d
```

This automatically injects all secrets as environment variables.

### Method 2: Using Infisical Docker Integration

Update your `docker-compose.prod.yml`:

```yaml
services:
  backend:
    image: ghcr.io/moondesk/quater/backend:latest
    environment:
      # Infisical will inject these
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:8080
    volumes:
      # Mount directory for certificates
      - ./certs:/app/certs:ro
    command: >
      sh -c "
      # Decode base64 certificates and save to files
      echo \$OPENIDDICT_ENCRYPTION_CERT_BASE64 | base64 -d > /app/certs/encryption.pfx &&
      echo \$OPENIDDICT_SIGNING_CERT_BASE64 | base64 -d > /app/certs/signing.pfx &&
      # Start the application
      dotnet Quater.Backend.Api.dll
      "
```

### Method 3: Using Infisical Agent (Recommended for Production)

For production deployments, use the Infisical Agent for automatic secret rotation:

```yaml
services:
  infisical-agent:
    image: infisical/cli:latest
    command: agent --token=${INFISICAL_TOKEN}
    volumes:
      - infisical-secrets:/secrets
    restart: unless-stopped

  backend:
    image: ghcr.io/moondesk/quater/backend:latest
    depends_on:
      - infisical-agent
    volumes:
      - infisical-secrets:/secrets:ro
    env_file:
      - /secrets/.env
```

---

## Certificate Rotation

### When to Rotate Certificates

- **Regularly**: Every 12 months (recommended)
- **After compromise**: Immediately if certificates are exposed
- **Before expiration**: Check certificate expiration dates

### Rotation Process

1. **Generate new certificates**:
   ```bash
   bash backend/scripts/generate-openiddict-certs.sh
   ```

2. **Encode and upload to Infisical**:
   ```bash
   base64 -w 0 certs/encryption.pfx > certs/encryption.pfx.b64
   base64 -w 0 certs/signing.pfx > certs/signing.pfx.b64
   
   infisical secrets set OPENIDDICT_ENCRYPTION_CERT_BASE64 --value="$(cat certs/encryption.pfx.b64)"
   infisical secrets set OPENIDDICT_SIGNING_CERT_BASE64 --value="$(cat certs/signing.pfx.b64)"
   ```

3. **Update certificate passwords** (if changed):
   ```bash
   infisical secrets set OPENIDDICT_ENCRYPTION_CERT_PASSWORD --value="new-password"
   infisical secrets set OPENIDDICT_SIGNING_CERT_PASSWORD --value="new-password"
   ```

4. **Restart application**:
   ```bash
   infisical run --env=production -- docker-compose -f docker/docker-compose.prod.yml restart backend
   ```

5. **Verify**:
   ```bash
   curl -f http://localhost:8080/health || echo "Health check failed"
   ```

---

## Troubleshooting

### Issue: "Infisical CLI not found"

**Solution**:
```bash
# Reinstall Infisical CLI
curl -1sLf 'https://dl.cloudsmith.io/public/infisical/infisical-cli/setup.deb.sh' | sudo -E bash
sudo apt-get update && sudo apt-get install -y infisical
```

### Issue: "Certificate not found at path"

**Solution**:
1. Verify certificates are decoded correctly:
   ```bash
   ls -lh /app/certs/
   ```

2. Check base64 decoding:
   ```bash
   echo $OPENIDDICT_ENCRYPTION_CERT_BASE64 | base64 -d > /tmp/test.pfx
   openssl pkcs12 -info -in /tmp/test.pfx -noout
   ```

### Issue: "Invalid certificate password"

**Solution**:
1. Verify password in Infisical matches certificate:
   ```bash
   infisical secrets get OPENIDDICT_ENCRYPTION_CERT_PASSWORD
   ```

2. Test certificate with password:
   ```bash
   openssl pkcs12 -info -in certs/encryption.pfx -passin pass:your-password -noout
   ```

### Issue: "Secrets not injected into container"

**Solution**:
1. Verify Infisical authentication:
   ```bash
   infisical login
   infisical secrets
   ```

2. Check environment selection:
   ```bash
   infisical init
   # Select correct project and environment
   ```

3. Use verbose mode:
   ```bash
   infisical run --env=production --debug -- docker-compose up
   ```

### Issue: "Certificate expired"

**Solution**:
1. Check certificate expiration:
   ```bash
   openssl pkcs12 -in certs/encryption.pfx -nokeys -passin pass:your-password | openssl x509 -noout -enddate
   ```

2. Generate new certificates:
   ```bash
   bash backend/scripts/generate-openiddict-certs.sh
   ```

3. Follow [Certificate Rotation](#certificate-rotation) process

---

## Security Best Practices

1. **Never commit certificates or secrets to version control**
   - Add `certs/` to `.gitignore`
   - Add `.env` to `.gitignore`

2. **Use separate Infisical environments**
   - `development` - for local development
   - `staging` - for testing
   - `production` - for live deployment

3. **Rotate secrets regularly**
   - Certificates: Every 12 months
   - Passwords: Every 90 days
   - API keys: Every 6 months

4. **Limit access to Infisical**
   - Use role-based access control
   - Grant minimum necessary permissions
   - Audit access logs regularly

5. **Enable Infisical audit logg  - Track who accessed which secrets
   - Monitor for suspicious activity
   - Set up alerts for unauthorized access

6. **Use Infisical service tokens for CI/CD**
   - Don't use personal tokens in automation
   - Scope tokens to specific environments
   - Rotate service tokens regularly

---

## Additional Resources

- [Infisical Documentation](https://infisical.com/docs)
- [OpenIddict Certificate Management](https://documentation.openiddict.com/configuration/encryption-and-signing-credentials.html)
- [Docker Secrets Best Practices](https://docs.docker.com/engine/swarm/secrets/)
- [Quater Backend AGENTS.md](../AGENTS.md) - Development guidelines

---

**Last Updated**: 2025-02-06  
**Maintainer**: Quater Development Team
