{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Quater Sync Protocol",
  "description": "Schema for bidirectional data synchronization between clients and server",
  "definitions": {
    "SyncRequest": {
      "type": "object",
      "required": ["deviceId", "lastSyncTimestamp", "changes"],
      "properties": {
        "deviceId": {
          "type": "string",
          "description": "Unique identifier for the client device",
          "example": "desktop-abc123"
        },
        "lastSyncTimestamp": {
          "type": "string",
          "format": "date-time",
          "description": "UTC timestamp of last successful sync",
          "example": "2026-01-25T10:30:00Z"
        },
        "changes": {
          "type": "array",
          "description": "List of changes to push to server",
          "items": {
            "$ref": "#/definitions/ChangeRecord"
          }
        }
      }
    },
    "SyncResponse": {
      "type": "object",
      "required": ["timestamp", "serverChanges", "conflicts", "accepted", "rejected"],
      "properties": {
        "timestamp": {
          "type": "string",
          "format": "date-time",
          "description": "Server timestamp to use for next sync",
          "example": "2026-01-25T10:35:00Z"
        },
        "serverChanges": {
          "type": "array",
          "description": "Changes from server since last sync",
          "items": {
            "$ref": "#/definitions/ChangeRecord"
          }
        },
        "conflicts": {
          "type": "array",
          "description": "Conflicts detected during sync",
          "items": {
            "$ref": "#/definitions/ConflictRecord"
          }
        },
        "accepted": {
          "type": "array",
          "description": "Client changes accepted by server",
          "items": {
            "type": "string",
            "format": "uuid",
            "description": "Entity ID"
          }
        },
        "rejected": {
          "type": "array",
          "description": "Client changes rejected by server",
          "items": {
            "$ref": "#/definitions/RejectionRecord"
          }
        }
      }
    },
    "ChangeRecord": {
      "type": "object",
      "required": ["entityType", "entityId", "action", "data", "version", "lastModified"],
      "properties": {
        "entityType": {
          "type": "string",
          "enum": ["Sample", "TestResult", "Parameter"],
          "description": "Type of entity being synced"
        },
        "entityId": {
          "type": "string",
          "format": "uuid",
          "description": "Unique identifier of the entity"
        },
        "action": {
          "type": "string",
          "enum": ["create", "update", "delete"],
          "description": "Type of change"
        },
        "data": {
          "type": "object",
          "description": "Entity data (null for delete action)",
          "oneOf": [
            {"$ref": "#/definitions/SampleData"},
            {"$ref": "#/definitions/TestResultData"},
            {"$ref": "#/definitions/ParameterData"}
          ]
        },
        "version": {
          "type": "integer",
          "description": "Optimistic locking version number",
          "example": 3
        },
        "lastModified": {
          "type": "string",
          "format": "date-time",
          "description": "UTC timestamp of last modification",
          "example": "2026-01-25T10:30:00Z"
        },
        "lastModifiedBy": {
          "type": "string",
          "description": "User ID who made the change",
          "example": "user-123"
        }
      }
    },
    "ConflictRecord": {
      "type": "object",
      "required": ["entityType", "entityId", "localVersion", "serverVersion"],
      "properties": {
        "entityType": {
          "type": "string",
          "enum": ["Sample", "TestResult", "Parameter"],
          "description": "Type of entity in conflict"
        },
        "entityId": {
          "type": "string",
          "format": "uuid",
          "description": "Unique identifier of the entity"
        },
        "localVersion": {
          "$ref": "#/definitions/VersionInfo",
          "description": "Client's version of the entity"
        },
        "serverVersion": {
          "$ref": "#/definitions/VersionInfo",
          "description": "Server's version of the entity"
        },
        "conflictType": {
          "type": "string",
          "enum": ["concurrent_update", "delete_update", "update_delete"],
          "description": "Type of conflict detected"
        }
      }
    },
    "VersionInfo": {
      "type": "object",
      "required": ["data", "version", "lastModified", "lastModifiedBy"],
      "properties": {
        "data": {
          "type": "object",
          "description": "Entity data"
        },
        "version": {
          "type": "integer",
          "description": "Version number"
        },
        "lastModified": {
          "type": "string",
          "format": "date-time",
          "description": "UTC timestamp of modification"
        },
        "lastModifiedBy": {
          "type": "string",
          "description": "User ID who made the change"
        }
      }
    },
    "RejectionRecord": {
      "type": "object",
      "required": ["entityId", "reason"],
      "properties": {
        "entityId": {
          "type": "string",
          "format": "uuid",
          "description": "Entity ID that was rejected"
        },
        "reason": {
          "type": "string",
          "enum": ["validation_error", "permission_denied", "not_found", "conflict"],
          "description": "Reason for rejection"
        },
        "message": {
          "type": "string",
          "description": "Human-readable error message",
          "example": "Sample collection date cannot be in the future"
        }
      }
    },
    "ConflictResolution": {
      "type": "object",
      "required": ["entityType", "entityId", "resolution", "selectedVersion"],
      "properties": {
        "entityType": {
          "type": "string",
          "enum": ["Sample", "TestResult", "Parameter"],
          "description": "Type of entity"
        },
        "entityId       "type": "string",
          "format": "uuid",
          "description": "Entity ID"
        },
        "resolution": {
          "type": "string",
          "enum": ["keep_local", "keep_server", "merge"],
          "description": "Resolution strategy chosen by user"
        },
        "selectedVersion": {
          "type": "object",
          "description": "The version to keep (after merge if applicable)"
        },
        "notes": {
          "type": "string",
          "maxLength": 1000,
          "description": "Optional notes explaining resolution decision"
        }
      }
    },
    "SampleData": {
      "type": "object",
      "required": ["type", "locationLatitude", "locationLongitude", "collectionDate", "collectorName", "status"],
      "properties": {
        "type": {
          "type": "string",
          "enum": ["drinking_water", "wastewater", "surface_water", "groundwater", "industrial_water"]
        },
        "locationLatitude": {
          "type": "number",
          "minimum": -90,
          "maximum": 90
        },
        "locationLongitude": {
          "type": "number",
          "minimum": -180,
          "maximum": 180
        },
        "locationDescription": {
          "type": "string",
          "maxLength": 200
        },
        "collectionDate": {
          "type": "string",
          "format": "date-time"
        },
        "collectorName": {
          "type": "string",
          "maxLength": 100
        },
        "notes": {
          "type": "string",
          "maxLength": 1000
        },
        "status": {
          "type": "string",
          "enum": ["pending", "completed", "archived"]
        },
        "labId": {
          "type": "string",
          "format": "uuid"
        },
        "createdBy": {
          "type": "string"
        },
        "createdDate": {
          "type": "string",
          "format": "date-time"
        }
      }
    },
    "TestResultData": {
      "type": "object",
      "required": ["sampleId", "parameterName", "value", "unit", "testDate", "technicianName", "complianceStatus"],
      "properties": {
        "sampleId": {
          "type": "string",
          "format": "uuid"
        },
        "parameterName": {
          "type": "string",
          "maxLength": 100
        },
        "value": {
          "type": "number",
          "minimum": 0
        },
        "unit": {
          "type": "string",
          "maxLength": 20
        },
        "testDate": {
          "type": "string",
          "format": "date-time"
        },
        "technicianName": {
          "type": "string",
          "maxLength": 100
        },
        "testMethod": {
          "type": "string",
          "maxLength": 200
               "complianceStatus": {
          "type": "string",
          "enum": ["pass", "fail", "warning"]
        },
        "createdBy": {
          "type": "string"
        },
        "createdDate": {
          "type": "string",
          "format": "date-time"
        }
      }
    },
    "ParameterData": {
      "type": "object",
      "required": ["name", "unit", "isActive"],
      "properties": {
        "name": {
          "type": "string",
          "maxLength": 100
        },
        "unit": {
          "type": "string",
          "maxLength": 20
        },
        "whoThreshold": {
          "type": "number"
        },
        "moroccanThreshold": {
          "type": "number"
        },
        "minValue": {
          "type": "number"
        },
        "maxValue": {
          "type": "number"
        },
        "description": {
          "type": "string",
          "maxLength": 500
        },
        "isActive": {
          "type": "boolean"
        }
      }
    }
  }
}
